name: C++ Lint & Format

on:
  push:
    paths:
      - 'cpp/**'
      - '.clang-tidy'
      - '.clang-format'
      - 'lint-cpp.sh'
      - 'clang-format.sh'
  pull_request:
    paths:
      - 'cpp/**'
      - '.clang-tidy'
      - '.clang-format'
      - 'lint-cpp.sh'
      - 'clang-format.sh'

jobs:
  lint_and_format:
    runs-on: ubuntu-latest

    steps:
      - name: ðŸ“¥ Checkout code
        uses: actions/checkout@v4

      - name: ðŸ› ï¸ Install clang-tidy & clang-format
        run: sudo apt-get update && sudo apt-get install -y clang-tidy clang-format

      - name: ðŸ” Run clang-tidy
        run: |
          find cpp -type f \( -name "*.cpp" -o -name "*.c" \) > cpp_files.txt
          while IFS= read -r file; do
            echo "Linting $file"
            clang-tidy "$file" -- -std=c++17 || exit 1
          done < cpp_files.txt

      - name: ðŸ”§ Check clang-format
        run: |
          diff=$(clang-format -style=file -output-replacements-xml $(find cpp -name '*.cpp' -o -name '*.h') | grep "<replacement " || true)
          if [ ! -z "$diff" ]; then
            echo "âŒ Code is not formatted! Please run: clang-format -i"
            exit 1
          fi
